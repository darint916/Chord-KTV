## üìù Directory Explanation
![Build Status](https://github.com/darint916/Chord-KTV/actions/workflows/dotnet-build-run-check.yml/badge.svg) ![Style Police Status](https://github.com/darint916/Chord-KTV/actions/workflows/enforce-code-style.yml/badge.svg)![Build Status](https://github.com/darint916/Chord-KTV/actions/workflows/react-build-check.yml/badge.svg) ![Style Police Status](https://github.com/darint916/Chord-KTV/actions/workflows/frontend-code-style.yml/badge.svg)


- **Controllers/** - Contains API controllers that handle incoming HTTP requests.
- **Data/** - Holds Repository facing files to directly query database, migrate database, and context.
- **Dtos/** - Houses Data Transfer Objects (DTOs) to structure API responses and also any other business logic models
- **Migrations/** - Stores database migration scripts for schema updates.
- **Models/** - Defines the application's core data models. (From Db)
- **Profiles/** - AutoMapper profiles for object transformations.
- **Properties/** - Holds project-level configuration settings.
- **Services/** - Contains business logic, API integrations (Interfaces), and service classes.
- **Utils/** - Any helper utilities or common functions used across the project.
- **bin/** & **obj/** - Generated by .NET for building and compiling the project.

---

## üí° Contribution Guidelines

1. Follow the existing folder structure when adding new files.
2. Keep controllers focused on request handling, moving logic to services.
3. Use DTOs for API responses to separate models from exposed data.
4. Always test your changes before making a pull request.

## PostgreSQL setup:

Make sure you have the PostgreSQL Docker image pulled, and that Docker Desktop is running.

Before building, run this command:
```bash
docker run -d -e POSTGRES_USER=<uname-for-postgres> -e POSTGRES_PASSWORD=<pwd-for-postgres> -p <free-port-number>:5432 postgres:15.4
```
This will start up a local containerized instance of PostgreSQL.

Create a secrets.json file with these contents:
```
{
    "ConnectionStrings:PostgreSql": "Host=localhost;Port=<port-no-for-postgres>;Database=postgres;Username=<uname-for-postgres>;Password=<pwd-for-postgres>"
}
```

After building, if you see an error like this:
```
fail: Microsoft.EntityFrameworkCore.Database.Command[20102]
      Failed executing DbCommand (17ms) [Parameters=[], CommandType='Text', CommandTimeout='5']
      SELECT "MigrationId", "ProductVersion"
      FROM "__EFMigrationsHistory"
      ORDER BY "MigrationId";
```
It's likely due to an issue with .NET EF core, this can be resolved by running
```bash
dotnet tool install --global dotnet-ef
```

This should allow you to build the project successfully using ```dotnet run```.


## Database model changes
If changes are made to any of the models, a migration is needed. Use PascalCase
```Powershell
dotnet ef migrations add <migration name>
dotnet ef database update
```

## Google Cloud for Handwriting Recognition Setup

Make sure that you have gcloud CLI installed. Run ```gcloud auth application-default login``` before running the backend.
This is a necessary step, since there is no way to pass API key into function call for Google Cloud Vision API.


### Authentication

Some endpoints may require authentication. The API provides a Google authentication endpoint: ```POST /api/auth/google```
Call with Google JWT Bearer token to enable access to endpoints that require authentication.
Note : User Activity Endpoints require auth. 

# ChordKTV API Documentation

This document outlines the REST API endpoints available in the ChordKTV application. The API provides functionality for handwriting recognition, quiz generation, song data management, and user activity tracking.

## Table of Contents
- [Authentication](#authentication)
- [Handwriting Recognition](#handwriting-recognition)
- [Quiz](#quiz)
- [Songs](#songs)
- [User Activity](#user-activity)

## Authentication

### Google Authentication
```
POST /api/auth/google
```

Authenticates a user with a Google ID token.

**Headers:**
- `Authorization`: Bearer {Google ID token}

**Response:**
```json
{
  "user": {
    "id": "uuid",
    "name": "string",
    "email": "string"
  },
  "token": "string"
}
```

**Status Codes:**
- `200 OK`: Authentication successful
- `401 Unauthorized`: Authentication failed
- `500 Internal Server Error`: Server error

## Handwriting Recognition

### Recognize Handwritten Text
```
POST /api/handwriting/ocr
```

Recognizes text from a handwritten image.

**Request Body:**
```json
{
  "image": "string", // base64 encoded image data
  "language": "enum", // LanguageCode (e.g., "EN", "JP", "KO")
  "expectedMatch": "string" // Optional, for verification
}
```

**Response:**
```json
{
  "recognizedText": "string",
  "matchPercentage": 0.0
}
```

**Status Codes:**
- `200 OK`: Recognition successful
- `400 Bad Request`: Invalid image data or parameters
- `500 Internal Server Error`: Server error

## Quiz

### Generate Romanization Quiz
```
POST /api/quiz/romanization
```

Generates a quiz focused on romanization of lyrics.

**Request Body:**
```json
{
  "songId": "uuid",
  "useCachedQuiz": false,
  "difficulty": 1, // Integer between 1-5
  "numQuestions": 5 // Integer between 1-20
}
```

**Response:**
```json
{
  "quizId": "uuid",
  "songId": "uuid",
  "difficulty": 0,
  "timestamp": "2023-01-01T00:00:00Z",
  "questions": [
    {
      "questionNumber": 0,
      "startTimestamp": "string",
      "endTimestamp": "string",
      "lyricPhrase": "string",
      "options": ["string"],
      "correctOptionIndex": 0
    }
  ]
}
```

**Status Codes:**
- `200 OK`: Quiz generated successfully
- `400 Bad Request`: Invalid parameters
- `404 Not Found`: Song not found
- `500 Internal Server Error`: Server error

### Generate Audio Quiz
```
POST /api/quiz/audio
```

Generates a quiz focused on audio recognition.

**Request Body & Response:** Same as romanization quiz

## Songs

### Get YouTube Playlist
```
GET /api/youtube/playlists/{playlistId}
```

Retrieves details of a YouTube playlist.

**Parameters:**
- `playlistId`: YouTube playlist ID
- `shuffle` (query, optional): Shuffle the videos (default: false)

**Response:**
```json
{
  "playlistTitle": "string",
  "videos": [
    {
      "title": "string",
      "artist": "string",
      "url": "string",
      "duration": "string"
    }
  ],
  "playlistThumbnailUrl": "string"
}
```

### Get LRC Lyrics
```
GET /api/lyrics/lrc/match
```

Retrieves synchronized lyrics in LRC format.

**Parameters:**
- `title` (query): Song title
- `artist` (query): Artist name
- `albumName` (query): Album name
- `duration` (query): Song duration in seconds

**Response:**
```json
{
  "id": 0,
  "romanizedId": 0,
  "name": "string",
  "trackName": "string",
  "artistName": "string",
  "albumName": "string",
  "duration": 0.0,
  "instrumental": false,
  "plainLyrics": "string",
  "syncedLyrics": "string",
  "romanizedPlainLyrics": "string",
  "romanizedSyncedLyrics": "string",
  "alternateTitles": ["string"],
  "alternateArtists": ["string"],
  "titleMatchScores": {
    "lrcExactMatch": false,
    "lrcRomanizedScore": 0,
    "lrcOriginalScore": 0,
    "lrcInputParamScore": 0
  },
  "artistMatchScores": {
    "lrcExactMatch": false,
    "lrcRomanizedScore": 0,
    "lrcOriginalScore": 0,
    "lrcInputParamScore": 0
  }
}
```

### Translate Lyrics
```
POST /api/lyrics/lrc/translation
```

Translates lyrics using ChatGPT.

**Request Body:**
```json
{
  "originalLyrics": "string",
  "languageCode": "enum", // LanguageCode
  "romanize": false,
  "translate": false
}
```

**Response:** Same as LRC Lyrics response

### Get Full Song Information
```
POST /api/songs/match
```

Retrieves complete song information by matching title, artist, and lyrics.

**Request Body:**
```json
{
  "title": "string",
  "artist": "string",
  "album": "string",
  "duration": "string",
  "lyrics": "string",
  "youTubeId": "string"
}
```

**Response:**
```json
{
  "id": "uuid",
  "title": "string",
  "alternateTitles": ["string"],
  "artist": "string",
  "featuredArtists": ["string"],
  "albumNames": ["string"],
  "releaseDate": "2023-01-01",
  "duration": "string",
  "genre": "string",
  "plainLyrics": "string",
  "lrcLyrics": "string",
  "lrcRomanizedLyrics": "string",
  "lrcTranslatedLyrics": "string",
  "youTubeId": "string",
  "alternateYoutubeIds": ["string"],
  "geniusMetaData": {
    "geniusId": 0,
    "headerImageUrl": "string",
    "songImageUrl": "string",
    "language": "enum" // LanguageCode
  },
  "titleMatchScores": {},
  "artistMatchScores": {}
}
```

### Get Songs by Album
```
GET /api/album/{albumName}
```

Retrieves songs from a specific album.

**Parameters:**
- `albumName`: Album name
- `artist` (query, optional): Artist name

**Response:**
```json
[
  {
    "id": "uuid",
    "title": "string",
    // Other song properties...
  }
]
```

### Search Genius
```
GET /api/songs/genius/search
```

Searches for songs using the Genius API.

**Parameters:**
- `searchQuery` (query, required): Search query

**Response:**
```json
[
  {
    "result": {
      "id": 0,
      "title": "string",
      "header_image_url": "string",
      "song_art_image_url": "string",
      "primary_artist_names": "string",
      "album": {
        "name": "string"
      }
    }
  }
]
```

### Find Instrumental Version
```
PUT /api/songs/{songId}/video/instrumental
```

Finds an instrumental YouTube video for a song.

**Parameters:**
- `songId`: UUID of the song

**Response:** YouTube ID as string

### Health Check
```
GET /api/health
```

Checks if the Song API is operational.

**Response:**
```json
{
  "message": "Song API is healthy."
}
```

## User Activity

### Add Playlist Activity
```
POST /api/user/activity/playlist
```

Records a user's interaction with a playlist.

**Request Body:**
```json
{
  "playlistId": "string",
  "playlistThumbnailUrl": "string",
  "title": "string",
  "datesPlayed": ["2023-01-01T00:00:00Z"],
  "lastPlayed": "2023-01-01T00:00:00Z",
  "isFavorite": false,
  "dateFavorited": "2023-01-01T00:00:00Z"
}
```

**Authentication Required:** Yes

### Add Quiz Result
```
POST /api/user/activity/quiz
```

Records a user's quiz result.

**Request Body:**
```json
{
  "quizId": "uuid",
  "score": 0.0,
  "language": "enum", // LanguageCode
  "dateCompleted": "2023-01-01T00:00:00Z",
  "correctAnswers": ["string"]
}
```

**Authentication Required:** Yes

### Add Song Activity
```
POST /api/user/activity/song
```

Records a user's interaction with a song.

**Request Body:**
```json
{
  "songId": "uuid",
  "isFavorite": false,
  "datesPlayed": ["2023-01-01T00:00:00Z"],
  "lastPlayed": "2023-01-01T00:00:00Z",
  "dateFavorited": "2023-01-01T00:00:00Z"
}
```

**Authentication Required:** Yes

### Toggle Favorite Song
```
PATCH /api/user/activity/favorite/song
```

Toggles a song's favorite status.

**Request Body:**
```json
{
  "songId": "uuid",
  "isFavorite": true,
  "isPlayed": false
}
```

**Authentication Required:** Yes

### Get Favorite Songs
```
GET /api/user/activity/favorite/songs
```

Retrieves user's favorite songs.

**Authentication Required:** Yes

## Common Data Types

### LanguageCode Enum
```
UNK, AF, AR, BG, BN, CA, CS, DA, DE, EL, EN, ES, ET, FA, FI, FR, GU, 
HE, HI, HR, HU, ID, IT, JA, KO, LT, LV, MS, NL, NO, PL, PT, RO, RU, 
SK, SL, SR, SV, TA, TE, TH, TR, UK, VI, ZH
```

### Handwriting Canvas Request
```json
{
  "image": "string", // base64 encoded image
  "language": "LanguageCode",
  "expectedMatch": "string" // optional
}
```

### Quiz Request
```json
{
  "songId": "uuid",
  "useCachedQuiz": false,
  "difficulty": 1, // 1-5
  "numQuestions": 5 // 1-20
}
```

### Authentication Considerations
Most endpoints related to user activity require authentication. Include the JWT token in the Authorization header:
```
Authorization: Bearer {token}
```

---

This is a general overview of the API. For more detailed information, refer to the API specification or contact the development team.


## License üìúüìù‚öñÔ∏è
This project is licensed under the [**MIT License**](LICENSE). üéºüéµüéß

If you have any questions, feel free to ask in the **issues** section! üöÄüé∂
