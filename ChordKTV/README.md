## üìù Directory Explanation
![Build Status](https://github.com/darint916/Chord-KTV/actions/workflows/dotnet-build-run-check.yml/badge.svg) ![Style Police Status](https://github.com/darint916/Chord-KTV/actions/workflows/enforce-code-style.yml/badge.svg)![Build Status](https://github.com/darint916/Chord-KTV/actions/workflows/react-build-check.yml/badge.svg) ![Style Police Status](https://github.com/darint916/Chord-KTV/actions/workflows/frontend-code-style.yml/badge.svg)


- **Controllers/** - Contains API controllers that handle incoming HTTP requests.
- **Data/** - Holds Repository facing files to directly query database, migrate database, and context.
- **Dtos/** - Houses Data Transfer Objects (DTOs) to structure API responses and also any other business logic models
- **Migrations/** - Stores database migration scripts for schema updates.
- **Models/** - Defines the application's core data models. (From Db)
- **Profiles/** - AutoMapper profiles for object transformations.
- **Properties/** - Holds project-level configuration settings.
- **Services/** - Contains business logic, API integrations (Interfaces), and service classes.
- **Utils/** - Any helper utilities or common functions used across the project.
- **bin/** & **obj/** - Generated by .NET for building and compiling the project.

---

## üí° Contribution Guidelines

1. Follow the existing folder structure when adding new files.
2. Keep controllers focused on request handling, moving logic to services.
3. Use DTOs for API responses to separate models from exposed data.
4. Always test your changes before making a pull request.

## PostgreSQL setup:

Make sure you have the PostgreSQL Docker image pulled, and that Docker Desktop is running.

Before building, run this command:
```bash
docker run -d -e POSTGRES_USER=<uname-for-postgres> -e POSTGRES_PASSWORD=<pwd-for-postgres> -p <free-port-number>:5432 postgres:15.4
```
This will start up a local containerized instance of PostgreSQL.

Create a secrets.json file with these contents:
```
{
    "ConnectionStrings:PostgreSql": "Host=localhost;Port=<port-no-for-postgres>;Database=postgres;Username=<uname-for-postgres>;Password=<pwd-for-postgres>"
}
```

After building, if you see an error like this:
```
fail: Microsoft.EntityFrameworkCore.Database.Command[20102]
      Failed executing DbCommand (17ms) [Parameters=[], CommandType='Text', CommandTimeout='5']
      SELECT "MigrationId", "ProductVersion"
      FROM "__EFMigrationsHistory"
      ORDER BY "MigrationId";
```
It's likely due to an issue with .NET EF core, this can be resolved by running
```bash
dotnet tool install --global dotnet-ef
```

This should allow you to build the project successfully using ```dotnet run```.


## Database model changes
If changes are made to any of the models, a migration is needed. Use PascalCase
```Powershell
dotnet ef migrations add <migration name>
dotnet ef database update
```

## API Documentation

### Authentication

Some endpoints may require authentication. The API provides a Google authentication endpoint: ```POST /api/auth/google```
Call with Google JWT Bearer token to enable access to endpoints that require authentication.

### Lyrics

#### ```GET /api/lyrics/lrc/search```

Returns time-synced lyrics from LRCLIB. Attempts to retrieve both original and romanized lyrics if they exist.
We use both of LRCLIB's endpoints (https://lrclib.net/docs), performing an exact match (if at least title and artist exists), and then also a fuzzier search function. Exact searches from most strict parameters to least strict. For the batch search, it sends api requests in parallel from most strict to least (20 entries max each call), along with key word extraction. Post processing involves sorting by fuzzy matching the title and artist and duration. 
When finding romanized lyrics, it does a more strict artist filter search, to match full words with the artist to try to get a very accurate match on the artist names.

**Query Parameters**:

- title (string): Song title

- artist (string): Song artist

- albumName (string): Album name

- duration (number): Song duration in seconds

**Response:**

- 200 OK: Search results

#### ```POST /api/lyrics/lrc/translation```

Translates lyrics between languages.

**Request Body** (application/json):
```json
{
  "originalLyrics": "string",
  "languageCode": "LanguageCode",
  "romanize": true,
  "translate": true
}
```

**Response:**

- 200 OK: Search results

### Songs

#### ```POST /api/songs/match```

Searches for songs with comprehensive details.

**Request Body** (application/json):
```json
{
  "title": "string",
  "artist": "string",
  "album": "string",
  "duration": "date-span",
  "lyrics": "string",
  "youTubeId": "string"
}
```
**Response:**

- 200 OK: Returns song details

    ```json
    {
        "id": "uuid",
        "title": "string",
        "alternateTitles": ["string"],
        "artist": "string",
        "featuredArtists": ["string"],
        "albumNames": ["string"],
        "releaseDate": "date",
        "duration": "date-span",
        "genre": "string",
        "plainLyrics": "string",
        "lrcLyrics": "string",
        "lrcRomanizedLyrics": "string",
        "lrcTranslatedLyrics": "string",
        "youTubeId": "string",
        "alternateYoutubeIds": ["string"],
        "geniusMetaData": {
            "geniusId": 0,
            "headerImageUrl": "string",
            "songImageUrl": "string",
            "language": "LanguageCode"
        },
        "titleMatchScores": {
            "lrcExactMatch": true,
            "lrcRomanizedScore": 0,
            "lrcOriginalScore": 0,
            "lrcInputParamScore": 0
        },
        "artistMatchScores": {
            "lrcExactMatch": true,
            "lrcRomanizedScore": 0,
            "lrcOriginalScore": 0,
            "lrcInputParamScore": 0
        }
    }
    ```
- 404 Not Found: Song not found

- 500 Internal Server Error: Server error

- 503 Service Unavailable: Service unavailable

#### ```GET /api/songs/genius/search```

Searches for lyrics on Genius.

**Query Parameters**:

- title (string): Song title

- artist (string): Song artist

- lyrics (string): Lyrics text

- forceRefresh (boolean, default=false): Force refresh cached results

**Response:**

- 200 OK: Search results

#### ```POST /api/songs/genius/search/batch```

Performs batch search for lyrics on Genius.

**Query Parameters:**

- forceRefresh (boolean, default=false): Force refresh cached results

**Response:**

- 200 OK: Batch search results

### Album

#### ```GET /api/album/{albumName}```

Retrieves details about an album.

**Path Parameters:**

- albumName (string): Album name

**Query Parameters:**

- artist (string): Artist name

**Response:**

- 200 OK: Album details

### Database Operations

#### ```GET /api/database/song```

Retrieves song details from the database.

**Query Parameters:**

- title (string, required): Song title

- artist (string, required): Song artist

- albumName (string): Album name

**Response:**

- 200 OK: Song details

#### ```POST /api/database/song```

Adds a song to the database.

**Request Body** (application/json):

```json
{
  "id": "uuid",
  "title": "string",
  "alternateTitles": ["string"],
  "artist": "string",
  "featuredArtists": ["string"],
  "albums": [
    {
      "id": "uuid",
      "isSingle": true,
      "name": "string",
      "artist": "string",
      "songs": [Song]
    }
  ],
  "releaseDate": "date",
  "genre": "string",
  "duration": "date-span",
  "plainLyrics": "string",
  "lrcLyrics": "string",
  "lrcRomanizedLyrics": "string",
  "lrcTranslatedLyrics": "string",
  "lrcId": 0,
  "romLrcId": 0,
  "youtubeId": "string",
  "alternateYoutubeIds": ["string"],
  "geniusMetaData": {
    "geniusId": 0,
    "headerImageUrl": "string",
    "headerImageThumbnailUrl": "string",
    "songImageUrl": "string",
    "songImageThumbnailUrl": "string",
    "language": "LanguageCode"
  }
}
```

**Response:**

- 200 OK: Song added successfully

#### ```GET /api/database/users/{email}```

Retrieves user details from the database.

**Path Parameters:**

- email (string): User email address

**Response:**

- 200 OK: User details

### Handwriting Recognition

#### ```POST /api/handwriting/ocr```

Recognizes handwritten text from an image.

**Request Body** (application/json):

```json
{
  "image": "string",
  "language": "LanguageCode",
  "expectedMatch": "string"
}
```

**Response:**

- 200 OK: Returns recognition results
    ```json
    {
        "recognizedText": "string",
        "matchPercentage": 0.0
    }
    ```
- 400 Bad Request: Invalid input

- 500 Internal Server Error: Server error

### Quiz

#### GET /api/quiz/romanization

Generates a quiz for romanizing song lyrics.

**Query Parameters:**

- songId (string, uuid): ID of the song

- useCachedQuiz (boolean, default=false): Use cached quiz if available

- difficulty (integer, default=3): Difficulty level

- numQuestions (integer, default=5): Number of questions

**Response:**

- 200 OK: Returns quiz questions
    ```json
    {
        "quizId": "uuid",
        "songId": "uuid",
        "difficulty": 0,
        "timestamp": "date-time",
        "questions": [
            {
            "questionNumber": 0,
            "lyricPhrase": "string",
            "options": ["string"],
            "correctOptionIndex": 0
            }
        ]
    }
    ```
- 400 Bad Request: Invalid parameters

- 404 Not Found: Song not found

- 500 Internal Server Error: Server error

### YouTube Playlists

#### ```GET /api/youtube/playlists/{playlistId}```

Retrieves details about a YouTube playlist.

**Path Parameters:**

- playlistId (string): YouTube playlist ID

**Query Parameters:**

- shuffle (boolean, default=false): Shuffle the playlist order

**Response:**

- 200 OK: Returns playlist details
    ```json
    {
        "playlistTitle": "string",
        "videos": [
            {
            "title": "string",
            "artist": "string",
            "url": "string",
            "duration": "date-span"
            }
        ]
    }
    ```
- 500 Internal Server Error: Server error

### Health Check

#### ```GET /api/health```

Checks the health status of the service.

**Response:**

- 200 OK: Service is healthy

## Google Cloud for Handwriting Recognition Setup

Make sure that you have gcloud CLI installed. Run ```gcloud auth application-default login``` before running the backend.
This is a necessary step, since there is no way to pass API key into function call for Google Cloud Vision API.

## License üìúüìù‚öñÔ∏è
This project is licensed under the [**MIT License**](LICENSE). üéºüéµüéß

If you have any questions, feel free to ask in the **issues** section! üöÄüé∂
